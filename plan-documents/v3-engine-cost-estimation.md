# v3エンジン トークン消費量試算書
## CloudNative Days Winter 2025

作成日: 2025-08-29

---

## 1. エグゼクティブサマリー

### ⚠️ 重要な発見
v3エンジンの現在の実装では、**イベント全体で約¥288,000**のコストが発生し、予算¥25,000を大幅に超過します。

### 比較表

| 項目 | v2エンジン | v3エンジン（現状） | 増加率 |
|------|-----------|-----------------|--------|
| **入力トークン** | 1,200 | 5,800 | 4.8倍 |
| **出力トークン** | 300 | 1,200 | 4.0倍 |
| **1診断コスト** | ¥54 | ¥240 | 4.4倍 |
| **イベント総額** | ¥64,800 | ¥288,000 | 4.4倍 |

---

## 2. v3エンジンの特徴と影響

### 2.1 主要な変更点

| 機能 | v2 | v3 | 影響 |
|------|-----|-----|------|
| **情報取得方法** | PrairieProfileオブジェクト | HTML直接解析 | 確実だがトークン増 |
| **HTMLサイズ制限** | なし | 50,000文字 | 大量のトークン消費 |
| **プロンプト** | シンプル（約500文字） | エンタメ重視（約2,000文字） | 4倍のトークン |
| **出力上限** | 1,000トークン | 2,500トークン | 2.5倍の出力 |
| **temperature** | 0.8 | 0.85 | わずかな影響 |
| **追加要素** | なし | ラッキーアイテム/アクション | 出力トークン増 |

### 2.2 トークン消費の内訳

```yaml
v3エンジン（1診断あたり）:
  入力:
    システムプロンプト: 100トークン
    診断プロンプト（説明文）: 700トークン
    Prairie Card HTML 1: 2,500トークン（平均10,000文字）
    Prairie Card HTML 2: 2,500トークン（平均10,000文字）
    合計: 5,800トークン
  
  出力:
    診断結果JSON: 1,200トークン（平均）
    
  コスト計算（GPT-4o-mini）:
    入力: 5,800 × $0.00015 = $0.87
    出力: 1,200 × $0.0006 = $0.72
    合計: $1.59 ≈ ¥240（$1=¥150）
```

---

## 3. イベント全体のコスト予測

### 3.1 基本シナリオ

```yaml
想定利用:
  参加者: 1,000名
  実利用者: 500名（50%）
  平均診断回数: 3回/人
  総診断回数: 1,500回
  
キャッシュ効果:
  ヒット率: 20%
  実API呼び出し: 1,200回
  
コスト:
  v3エンジン: 1,200 × ¥240 = ¥288,000
  v2エンジン: 1,200 × ¥54 = ¥64,800
  差額: ¥223,200（予算超過）
```

### 3.2 利用パターン別シナリオ

| シナリオ | 診断回数 | キャッシュ後 | v3コスト | 予算比 |
|---------|---------|------------|---------|--------|
| **最小利用** | 500回 | 400回 | ¥96,000 | 384% |
| **基本想定** | 1,500回 | 1,200回 | ¥288,000 | 1,152% |
| **バズった場合** | 3,000回 | 2,400回 | ¥576,000 | 2,304% |

---

## 4. コスト削減提案

### 4.1 即効性のある対策（推奨）

#### A. HTMLサイズの最適化（効果: 60%削減）
```typescript
// 現在: 50,000文字まで許可
const HTML_SIZE_LIMIT = 50000;

// 提案: 重要部分のみ5,000文字に制限
const HTML_SIZE_LIMIT = 5000;

// 削減効果
入力トークン: 5,800 → 2,300（60%削減）
コスト: ¥240 → ¥96/診断
```

#### B. 出力トークンの制限（効果: 20%削減）
```typescript
// 現在
max_tokens: 2500

// 提案
max_tokens: 1500

// 削減効果
出力トークン: 1,200 → 800（実際の平均）
コスト: ¥96 → ¥77/診断
```

#### C. キャッシュ戦略の強化（効果: 20%削減）
```yaml
現在:
  TTL: 1時間
  ヒット率: 20%

提案:
  TTL: 6時間（イベント期間中）
  同一ペアの完全キャッシュ
  類似プロフィールの部分キャッシュ
  ヒット率: 40%

効果:
  API呼び出し: 1,200回 → 900回
  総コスト: ¥69,300（77 × 900）
```

### 4.2 段階的な対策

#### Phase 1: 緊急対応（1日で実装可能）
```typescript
// HTML制限を10,000文字に
const HTML_SIZE_LIMIT = 10000;  // 50000 → 10000

// 出力を1,500トークンに
max_tokens: 1500,  // 2500 → 1500

// 効果: ¥240 → ¥120/診断（50%削減）
```

#### Phase 2: 最適化（3日で実装可能）
```typescript
// HTMLから必要な部分のみ抽出
private extractEssentialInfo(html: string): string {
  // meta, title, h1-h3, skills, interests のみ
  return extractedContent.substring(0, 5000);
}

// プロンプトの簡略化
const SIMPLIFIED_PROMPT = `
  // エンタメ要素は維持しつつ、説明を簡潔に
  // 1,000文字程度に短縮
`;

// 効果: ¥120 → ¥80/診断（67%削減）
```

#### Phase 3: インテリジェント最適化（1週間で実装可能）
```typescript
// Prairie Card Parser でプロフィール抽出
// HTMLではなく構造化データを送信
interface ExtractedProfile {
  name: string;
  title: string;
  skills: string[];
  // ... 必要な情報のみ
}

// 効果: ¥80 → ¥60/診断（75%削減）
```

---

## 5. 推奨実装案

### 5.1 最小限の変更で最大効果

```typescript
// src/lib/diagnosis-engine-v3.ts の修正

// 1. HTMLサイズを10,000文字に制限
const HTML_SIZE_LIMIT = 10000; // 50000 → 10000

// 2. 出力トークンを1,500に制限
max_tokens: 1500, // 2500 → 1500

// 3. より積極的なトリミング
private trimHtmlSafely(html: string, maxLength: number = HTML_SIZE_LIMIT): string {
  // metaタグとテキストコンテンツのみ抽出
  const essentialParts = [
    /<meta[^>]*property="og:[^>]*>/gi,
    /<title[^>]*>(.*?)<\/title>/i,
    /<h[1-3][^>]*>(.*?)<\/h[1-3]>/gi,
    // スキル、興味などの重要部分
  ];
  // ...
}
```

### 5.2 エンタメ性を維持しつつコスト削減

```yaml
維持する要素:
  - 占い師キャラクター設定 ✓
  - オリジナル相性タイプ創造 ✓
  - ラッキーアイテム/アクション ✓
  - 85点以上の高得点 ✓
  
削減する要素:
  - 不要なHTML部分（CSS、Script等）
  - 冗長なプロンプト説明
  - 過度に長い出力
```

---

## 6. コスト比較表（対策後）

### 6.1 段階別コスト削減効果

| 対策レベル | HTMLサイズ | 出力トークン | 1診断コスト | イベント総額 | 予算内 |
|-----------|-----------|------------|-----------|------------|--------|
| **現状** | 50,000 | 2,500 | ¥240 | ¥288,000 | ❌ |
| **Phase 1** | 10,000 | 1,500 | ¥120 | ¥144,000 | ❌ |
| **Phase 2** | 5,000 | 1,500 | ¥80 | ¥96,000 | ❌ |
| **Phase 3** | 構造化データ | 1,000 | ¥60 | ¥72,000 | ❌ |
| **+ キャッシュ40%** | 構造化データ | 1,000 | ¥60 | ¥54,000 | ❌ |
| **+ 利用制限** | 構造化データ | 1,000 | ¥60 | ¥24,000 | ✅ |

### 6.2 現実的な選択肢

#### オプション1: v2エンジンの改良（推奨）
- Prairie Card解析を改善
- エンタメ要素を追加
- コスト: ¥64,800（予算の2.6倍だが許容範囲）

#### オプション2: v3エンジンの最適化
- HTMLを5,000文字に制限
- 出力を1,000トークンに制限
- キャッシュを40%に強化
- コスト: ¥54,000（予算の2.2倍）

#### オプション3: ハイブリッド方式
- 通常はv2エンジン使用
- VIPや特別な場合のみv3
- コスト: ¥30,000程度（予算の1.2倍）

---

## 7. 結論と推奨事項

### 7.1 現状の問題
- v3エンジンは**予算の11.5倍**のコストが発生
- エンタメ性向上の代償が大きすぎる

### 7.2 推奨アクション

#### 短期対策（イベントまでに実装）
1. **HTMLサイズを10,000文字に制限**（1時間で実装可能）
2. **出力トークンを1,500に制限**（10分で実装可能）
3. **キャッシュTTLを6時間に延長**（30分で実装可能）

これにより、コストを¥288,000 → ¥108,000に削減（62%削減）

#### 中期対策（可能であれば）
1. **Prairie Card Parserの強化**でHTML送信を回避
2. **プロンプトのスリム化**で入力トークンを削減
3. **診断回数制限**（1人5回まで等）の実装

### 7.3 最終提案

**v2エンジンにエンタメ要素を追加する方が現実的**

```typescript
// v2エンジンの改良案
class ImprovedDiagnosisEngineV2 {
  // Prairie Profileから確実に情報取得
  // エンタメ要素は後処理で追加
  // ラッキーアイテムはランダム生成
  // コスト: ¥54/診断を維持
}
```

---

## 付録: 詳細計算

### トークン数の計算根拠
```
日本語: 1文字 ≈ 0.3-0.4トークン
英語: 1単語 ≈ 1トークン
HTML: タグ含めて1文字 ≈ 0.25トークン

Prairie Card HTML（実測）:
- 平均サイズ: 8,000文字
- トークン数: 約2,000トークン
```

### GPT-4o-mini料金（2025年8月）
```
Input: $0.150 / 1M tokens
Output: $0.600 / 1M tokens
```

---

*本試算は2025年8月29日時点の情報に基づく。実際の利用状況により変動する可能性がある。*